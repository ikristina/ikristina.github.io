---
export interface Props {
  posts: any[];
}

const { posts } = Astro.props;

// Generate calendar for current month
const today = new Date();
const currentMonth = today.getMonth();
const currentYear = today.getFullYear();
const firstDay = new Date(currentYear, currentMonth, 1);
const startDate = new Date(firstDay);
startDate.setDate(startDate.getDate() - firstDay.getDay());

const calendarDays = [];
for (
  let d = new Date(startDate);
  calendarDays.length < 42;
  d.setDate(d.getDate() + 1)
) {
  const dateStr = d.toISOString().split("T")[0];
  const hasPost = posts.some((post) => {
    if (!post.frontmatter.date) return false;
    const postDate = new Date(post.frontmatter.date);
    if (isNaN(postDate.getTime())) return false;
    return postDate.toISOString().split("T")[0] === dateStr;
  });
  const isToday = d.toDateString() === today.toDateString();
  const isCurrentMonth = d.getMonth() === currentMonth;
  calendarDays.push({
    date: d.getDate(),
    hasPost,
    isToday,
    isCurrentMonth,
    fullDate: dateStr,
  });
}

// Generate tag cloud
const tagCounts = {};
posts.forEach((post) => {
  post.frontmatter.tags?.forEach((tag) => {
    tagCounts[tag] = (tagCounts[tag] || 0) + 1;
  });
});
const tags = Object.entries(tagCounts).map(([tag, count]) => ({ tag, count }));

const postDates = posts.map((p) => p.frontmatter.date).filter(Boolean);
---

<aside class="sidebar">
  <div class="about">
    <img
      src="https://avatars.githubusercontent.com/u/10219431"
      alt="Profile"
      class="profile-pic"
    />
    <h3>About Me</h3>
    <p>
      I'm a software developer, mostly working with Go. I spend my free time
      reading, learning random things, and watching horror movies. I collect
      useless knowledge like other people collect stamps and constantly forget
      what I was supposed to be doing (and where did my coffee cup go?). My
      brain works in chaos, jumping between ideas for new hobbies, and seeking
      new learning resources, until something clicks. Occasionally coherent in
      writing.
    </p>
    
    <div class="buy-me-coffee">
      <a href="https://www.buymeacoffee.com/ikristina" target="_blank" class="coffee-button">
        ☕ Buy me a coffee
      </a>
    </div>
    
    <div class="social-links">
      <a href="https://www.linkedin.com/in/i-kristina/" title="LinkedIn">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
          <path
            d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"
          ></path>
        </svg>
      </a>
      <a href="https://bsky.app/profile/ikristina.bsky.social" title="Bluesky">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
          <path
            d="M12 10.8c-1.087-2.114-4.046-6.053-6.798-7.995C2.566.944 1.561 1.266.902 1.565.139 1.908 0 3.08 0 3.768c0 .69.378 5.65.624 6.479.815 2.736 3.713 3.66 6.383 3.364.136-.02.275-.039.415-.056-.138.018-.276.037-.414.056-2.67-.296-5.568.628-6.383 3.364C.378 17.902 0 22.862 0 23.55c0 .688.139 1.86.902 2.203.659.299 1.664.621 4.3-1.24C7.954 22.571 10.913 18.632 12 16.518c1.087 2.114 4.046 6.053 6.798 7.995 2.636 1.861 3.641 1.539 4.3 1.24.763-.343.902-1.515.902-2.203 0-.688-.378-5.648-.624-6.477-.815-2.736-3.713-3.66-6.383-3.364-.138.019-.276.038-.414.056.14-.017.279-.036.415-.056 2.67.296 5.568-.628 6.383-3.364.246-.829.624-5.789.624-6.479 0-.688-.139-1.86-.902-2.203-.659-.299-1.664-.621-4.3 1.24C16.046 4.747 13.087 8.686 12 10.8z"
          ></path>
        </svg>
      </a>
      <a href="https://mastodon.social/@ikristina" title="Mastodon">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
          <path
            d="M23.268 5.313c-.35-2.578-2.617-4.61-5.304-5.004C17.51.242 15.792 0 11.813 0h-.03c-3.98 0-4.835.242-5.288.309C3.882.692 1.496 2.518.917 5.127.64 6.412.61 7.837.661 9.143c.074 1.874.088 3.745.26 5.611.118 1.24.325 2.47.62 3.68.55 2.237 2.777 4.098 4.96 4.857 2.336.792 4.849.923 7.256.38.265-.061.527-.132.786-.213.585-.184 1.27-.39 1.774-.753a.057.057 0 0 0 .023-.043v-1.809a.052.052 0 0 0-.02-.041.053.053 0 0 0-.046-.01 20.282 20.282 0 0 1-4.709.545c-2.73 0-3.463-1.284-3.674-1.818a5.593 5.593 0 0 1-.319-1.433.053.053 0 0 1 .066-.054c1.517.363 3.072.546 4.632.546.376 0 .75 0 1.125-.01 1.57-.044 3.224-.124 4.768-.422.038-.008.077-.015.11-.024 2.435-.464 4.753-1.92 4.989-5.604.008-.145.03-1.52.03-1.67.002-.512.167-3.63-.024-5.545zm-3.748 9.195h-2.561V8.29c0-1.309-.55-1.976-1.67-1.976-1.23 0-1.846.79-1.846 2.35v3.403h-2.546V8.663c0-1.56-.617-2.35-1.848-2.35-1.112 0-1.668.668-1.67 1.977v6.218H4.822V8.102c0-1.31.337-2.35 1.011-3.12.696-.77 1.608-1.164 2.74-1.164 1.311 0 2.302.5 2.962 1.498l.638 1.06.638-1.06c.66-.999 1.65-1.498 2.96-1.498 1.13 0 2.043.395 2.74 1.164.675.77 1.012 1.81 1.012 3.12z"
          ></path>
        </svg>
      </a>
      <a href="https://github.com/ikristina" title="GitHub">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
          <path
            d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"
          ></path>
        </svg>
      </a>
      <a href="/rss.xml" title="RSS Feed">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
          <path
            d="M6.503 20.752c0 1.794-1.456 3.248-3.251 3.248S0 22.546 0 20.752s1.456-3.248 3.252-3.248 3.251 1.454 3.251 3.248zM1.677 6.082v4.15c6.988 0 12.65 5.662 12.65 12.65h4.15c0-9.271-7.529-16.8-16.8-16.8zM1.677.014v4.15C14.44 4.164 24 13.724 24 26.487h4.15C28.15 11.952 16.212.014 1.677.014z"
          ></path>
        </svg>
      </a>
    </div>
    <div class="calendar">
      <div class="calendar-header">
        <button class="calendar-nav" id="prev-month">‹</button>
        <h4 id="calendar-title">
          {
            new Date(currentYear, currentMonth).toLocaleDateString("en-US", {
              month: "long",
            })
          }
        </h4>
        <button class="calendar-nav" id="next-month">›</button>
      </div>
      <div class="year-controls">
        <button class="year-nav" id="prev-year">‹‹</button>
        <span id="year-display">{currentYear}</span>
        <button class="year-nav" id="next-year">››</button>
      </div>
      <div class="calendar-grid" id="calendar-grid">
        {
          calendarDays.map((day) => (
            <div
              class={`calendar-day ${day.isToday ? "today" : ""} ${
                day.hasPost ? "has-post" : ""
              } ${!day.isCurrentMonth ? "text-gray-400" : ""}`}
              data-date={day.fullDate}
              data-has-post={day.hasPost}
            >
              {day.isCurrentMonth ? day.date : ""}
            </div>
          ))
        }
      </div>
    </div>
    <div class="tag-cloud">
      <h4>Tags</h4>
      <div class="tags-container">
        {
          tags.map(({ tag, count }) => (
            <a
              href={`/tags/${tag}`}
              class="tag-item"
              style={`font-size: ${0.8 + count * 0.2}rem`}
            >
              {tag}
            </a>
          ))
        }
      </div>
    </div>
  </div>
</aside>

<script define:vars={{ currentMonth, currentYear, postDates }}>
  let calendarMonth = currentMonth;
  let calendarYear = currentYear;
  const posts = postDates;

  function updateCalendar() {
    document.getElementById("calendar-title").textContent = new Date(
      calendarYear,
      calendarMonth,
    ).toLocaleDateString("en-US", { month: "long" });
    document.getElementById("year-display").textContent = calendarYear;

    const firstDay = new Date(calendarYear, calendarMonth, 1);
    const startDate = new Date(firstDay);
    startDate.setDate(startDate.getDate() - firstDay.getDay());

    const calendarGrid = document.getElementById("calendar-grid");
    calendarGrid.innerHTML = "";

    const today = new Date();

    for (let i = 0; i < 42; i++) {
      const d = new Date(startDate);
      d.setDate(d.getDate() + i);

      const dateStr = d.toISOString().split("T")[0];
      const hasPost = posts.some((p) => {
        const postDate = new Date(p);
        return (
          !isNaN(postDate.getTime()) &&
          postDate.toISOString().split("T")[0] === dateStr
        );
      });
      const isToday =
        d.getDate() === today.getDate() &&
        d.getMonth() === today.getMonth() &&
        d.getFullYear() === today.getFullYear();
      const isCurrentMonth = d.getMonth() === calendarMonth;

      const dayEl = document.createElement("div");
      dayEl.className = `calendar-day ${isToday && isCurrentMonth ? "today" : ""} ${hasPost ? "has-post" : ""} ${!isCurrentMonth ? "text-gray-400" : ""}`;
      dayEl.textContent = isCurrentMonth ? d.getDate() : "";
      dayEl.setAttribute("data-date", dateStr);
      dayEl.setAttribute("data-has-post", hasPost);
      calendarGrid.appendChild(dayEl);
    }
  }

  document.getElementById("prev-month").addEventListener("click", () => {
    calendarMonth--;
    if (calendarMonth < 0) {
      calendarMonth = 11;
      calendarYear--;
    }
    updateCalendar();
  });

  document.getElementById("next-month").addEventListener("click", () => {
    calendarMonth++;
    if (calendarMonth > 11) {
      calendarMonth = 0;
      calendarYear++;
    }
    updateCalendar();
  });

  document.getElementById("prev-year").addEventListener("click", () => {
    calendarYear--;
    updateCalendar();
  });

  document.getElementById("next-year").addEventListener("click", () => {
    calendarYear++;
    updateCalendar();
  });

  document.addEventListener("click", (e) => {
    const target = e.target.closest(".calendar-day");
    if (
      target &&
      target.classList.contains("has-post") &&
      target.textContent.trim() !== ""
    ) {
      const year = calendarYear;
      const month = calendarMonth;
      const day = parseInt(target.textContent);
      const date = new Date(year, month, day).toISOString().split("T")[0];
      window.location.href = `/date/${date}`;
    }
  });
</script>
